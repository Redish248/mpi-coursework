jacocoTestCoverageVerification {
    violationRules {
        rule {
            element = 'CLASS'
            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.80
            }
            excludes = [
                    'itmo.mpi.MpiApplication',
                    'itmo.mpi.config.security.**',
                    'itmo.mpi.exception.**',
                    'itmo.mpi.dto.**',
                    'itmo.mpi.entity.**',
                    'itmo.mpi.model.**',
                    'itmo.mpi.repository.**',
                    'itmo.mpi.service.**',
                    'itmo.mpi.impl.FsbAgentServiceImpl',
                    'itmo.mpi.controller.ProfilesController',
                    'itmo.mpi.util.**',
                    'itmo.mpi.utils.**',
            ]
        }
    }
}

def coverageExclusions = [
        '**/itmo/mpi/MpiApplication',
        '**/itmo/mpi/security/config/**',
        '**/itmo/mpi/exception/**',
        '**/itmo/mpi/dto/**',
        '**/itmo/mpi/entity/**',
        '**/itmo/mpi/model/**',
        '**/itmo/mpi/repository/**',
        '**/itmo/mpi/service/**',
        '**/itmo/mpi/util/**',
        '**/itmo/mpi/utils/**',
]

jacocoTestReport {
    dependsOn(jacocoTestCoverageVerification)
    reports {
        xml.enabled true
        csv.enabled false
        html.enabled true
        html.destination file("${buildDir}/reports/coverage")
        xml.destination file("${buildDir}/reports/jacoco.xml")
    }
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: coverageExclusions)
        }))
    }
}

task testWithCoverage {
    check.dependsOn jacocoTestCoverageVerification
    dependsOn test
    dependsOn jacocoTestReport
    dependsOn check
}